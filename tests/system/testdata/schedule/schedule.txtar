# Precondition: create project.
ak project create --name schedules_project
return code == 0
output equals 'project_id: prj_00000000000000000000000001'

ak deploy --manifest schedule.yaml --file cron.star
return code == 0

ak trigger list
return code == 0
output equals 'trigger_id:"trg_00000000000000000000000005"  name:"cron"  env_id:"env_00000000000000000000000004"  event_type:"scheduler"  code_location:{path:"cron.star"  name:"on_cron_trigger"}  data:{key:"schedule"  value:{string:{v:"*/1 * * * * * *"}}}  data:{key:"schedule_id"  value:{string:{v:"cron_trg_00000000000000000000000005"}}}'

# env_00000000000000000000000004
# bld_00000000000000000000000007
# dep_00000000000000000000000008

wait 5s for session ses_00000000000000000000000009
ak session log ses_00000000000000000000000009 --no-timestamps --prints-only
return code == 0
output equals 'cron'

wait 5s for session ses_0000000000000000000000000b
ak session log ses_0000000000000000000000000b --no-timestamps --prints-only
return code == 0
output equals 'cron'

# remove trigger and effectively cancel cron
ak trigger delete trg_00000000000000000000000005
return code == 0

ak trigger list
return code == 0
output equals ''

# sleep 3 seconds this should be more than enough
sleep 3s

# only 2 sessions since trigger and schedule were cancelled
ak session list
return code == 0
output regex file sessions.txt


-- schedule.yaml --
version: v1
project:
  name: cron
  triggers:
    - name: cron
      schedule: "*/1 * * * * * *"  # every sec
      call: cron.star:on_cron_trigger


-- cron.star --
def on_cron_trigger():
    print("cron")

-- sessions.txt --
session_id:"ses_0000000000000000000000000b"  build_id:"bld_00000000000000000000000007"  env_id:"env_00000000000000000000000004"  entrypoint:{path:"cron.star"  name:"on_cron_trigger"}  created_at:{seconds:\d+  nanos:\d+}  updated_at:{seconds:\d+  nanos:\d+}  state:SESSION_STATE_TYPE_COMPLETED  deployment_id:"dep_00000000000000000000000008"  event_id:"evt_00000000000000000000000006"
session_id:"ses_00000000000000000000000009"  build_id:"bld_00000000000000000000000007"  env_id:"env_00000000000000000000000004"  entrypoint:{path:"cron.star"  name:"on_cron_trigger"}  created_at:{seconds:\d+  nanos:\d+}  updated_at:{seconds:\d+  nanos:\d+}  state:SESSION_STATE_TYPE_COMPLETED  deployment_id:"dep_00000000000000000000000008"  event_id:"evt_00000000000000000000000006"
