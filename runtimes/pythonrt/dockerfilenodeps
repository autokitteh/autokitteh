FROM python:3.11-slim AS build

RUN apt-get update && apt-get install --yes curl && rm -rf /var/lib/apt/lists/*

RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="~/.local/bin:$PATH"

WORKDIR /runner
COPY pyproject.toml .
RUN uv pip install .[all]

COPY py-sdk py-sdk
RUN cd py-sdk && uv pip install .

# https://stackoverflow.com/questions/78599865/how-to-install-missing-python-modules-on-distroless-image
FROM gcr.io/distroless/python3-debian12
USER 65532:65532

COPY --from=build /usr/local/lib/python3.11/site-packages /usr/lib/python3.11/site-packages
COPY --from=build /root/.local/bin/uv /usr/local/bin

COPY --chown=65532:65532  runner /runner
COPY --chown=65532:65532 workflow /workflow

ENV PYTHONPATH=/usr/lib/python3.11/site-packages
