package sdkservices

import (
	"context"
	"io/fs"

	"go.autokitteh.dev/autokitteh/sdk/sdkbuildfile"
	"go.autokitteh.dev/autokitteh/sdk/sdkerrors"
	"go.autokitteh.dev/autokitteh/sdk/sdkexecutor"
	"go.autokitteh.dev/autokitteh/sdk/sdktypes"
)

type Runtimes interface {
	List(ctx context.Context) ([]sdktypes.Runtime, error)
	New(ctx context.Context, name sdktypes.Symbol) (Runtime, error)

	Build(ctx context.Context, fs fs.FS, symbols []sdktypes.Symbol, memo map[string]string) (*sdkbuildfile.BuildFile, error)

	Run(
		ctx context.Context,
		rid sdktypes.RunID,
		path string,
		build *sdkbuildfile.BuildFile,
		globals map[string]sdktypes.Value,
		cbs *RunCallbacks,
	) (Run, error)
}

type Runtime interface {
	Get() sdktypes.Runtime

	// Returns sdktypes.ProgramErrorAsError if not internal error.
	Build(ctx context.Context, fs fs.FS, path string, symbols []sdktypes.Symbol) (sdktypes.BuildArtifact, error)

	// Returns sdktypes.ProgramErrorAsError if not internal error.
	Run(
		ctx context.Context,
		rid sdktypes.RunID, // generated by caller. guaranteed to be unique system-wide.
		path string, // where to start running from.
		compiled map[string][]byte,
		values map[string]sdktypes.Value,
		cbs *RunCallbacks,
	) (Run, error)
}

type (
	RunLoadFunc    = func(ctx context.Context, rid sdktypes.RunID, path string) (map[string]sdktypes.Value, error)
	RunCallFunc    = func(ctx context.Context, rid sdktypes.RunID, v sdktypes.Value, args []sdktypes.Value, kwargs map[string]sdktypes.Value) (sdktypes.Value, error)
	RunPrintFunc   = func(ctx context.Context, rid sdktypes.RunID, text string)
	NewRunIDFunc   = func() sdktypes.RunID
	DebugTraceFunc = func(ctx context.Context, rid sdktypes.RunID, callstack []sdktypes.CallFrame, extra map[string]string)
)

type RunCallbacks struct {
	// Returns sdktypes.ProgramErrorAsError if not internal error.
	Load RunLoadFunc

	// Returns sdktypes.ProgramErrorAsError if not internal error.
	Call RunCallFunc

	Print RunPrintFunc

	NewRunID NewRunIDFunc

	DebugTrace DebugTraceFunc
}

type Run interface {
	ID() sdktypes.RunID

	Close()

	sdkexecutor.Executor
}

func (rc *RunCallbacks) SafeLoad(ctx context.Context, rid sdktypes.RunID, path string) (map[string]sdktypes.Value, error) {
	if rc == nil || rc.Load == nil {
		return nil, nil
	}

	return rc.Load(ctx, rid, path)
}

func (rc *RunCallbacks) SafeCall(ctx context.Context, rid sdktypes.RunID, v sdktypes.Value, args []sdktypes.Value, kwargs map[string]sdktypes.Value) (sdktypes.Value, error) {
	if rc == nil || rc.Call == nil {
		return sdktypes.InvalidValue, sdkerrors.ErrNotImplemented
	}

	return rc.Call(ctx, rid, v, args, kwargs)
}

func (rc *RunCallbacks) SafePrint(ctx context.Context, rid sdktypes.RunID, text string) {
	if rc == nil || rc.Print == nil {
		return
	}

	rc.Print(ctx, rid, text)
}

func (rc *RunCallbacks) SafeNewRunID() sdktypes.RunID { return sdktypes.NewRunID() }

func (rc *RunCallbacks) SafeDebugTrace(ctx context.Context, rid sdktypes.RunID, callstack []sdktypes.CallFrame, extra map[string]string) {
	if rc == nil || rc.DebugTrace == nil {
		return
	}

	rc.DebugTrace(ctx, rid, callstack, extra)
}
