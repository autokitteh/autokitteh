# See also "docker-*.yml" and "release.yml" for Docker images CI.
# https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions
# https://github.com/marketplace/actions/amazon-ecr-login-action-for-github-actions
# https://github.com/marketplace/actions/build-and-push-docker-images

name: Manual Docker Image

# concurrency:
#     group: ${{ github.ref }}
#     cancel-in-progress: true

# run-name: Publish image ${{inputs.enterprise && 'ee/server' || 'server'}}:${{inputs.version}} to ECR

on:
    workflow_dispatch:
        # inputs:
        #     version:
        #         type: string
        #         required: true
        #         description: version to push
        #     enterprise:
        #         type: boolean
        #         required: false
        #         default: false
        #         description: build enterprise image

jobs:
    goreleaser:
        name: GoReleaser
        runs-on: ubuntu-latest
        timeout-minutes: 30
        permissions:
            contents: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: "v0.20.0"
            - name: Free up space
              run: |
                  echo "=============================================================================="
                  echo "Freeing up disk space on CI system"
                  echo "=============================================================================="

                  echo "Listing 100 largest packages"
                  dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n | tail -n 100
                  df -h
                  echo "Removing large packages"
                  sudo apt-get remove -y '^ghc-8.*' || true
                  sudo apt-get remove -y '^dotnet-.*' || true
                  sudo apt-get remove -y '^llvm-.*' || true
                  sudo apt-get remove -y 'php.*' || true
                  sudo apt-get remove -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
                  sudo apt-get autoremove -y
                  sudo apt-get clean
                  df -h
                  echo "Removing large directories"
                  # deleting 15GB
                  rm -rf /usr/share/dotnet/
                  df -h
            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: go.mod

            - name: Fetch web platform
              run: make webplatform

            - name: Run GoReleaser
              uses: goreleaser/goreleaser-action@v6
              with:
                  version: latest
                  args: build --clean
    # build-standard:
    #     if: ${{ !inputs.enterprise }}
    #     uses: ./.github/workflows/docker.yml
    #     with:
    #         push: true
    #         image: server
    #         version: ${{ inputs.version }}
    #     secrets: inherit
    # build-ee:
    #     if: ${{ inputs.enterprise }}
    #     uses: ./.github/workflows/docker.yml
    #     with:
    #         push: true
    #         image: ee/server
    #         buildTags: "enterprise"
    #         version: ${{ inputs.version }}
    #     secrets: inherit
