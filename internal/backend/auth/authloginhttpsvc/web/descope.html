<!DOCTYPE html>

<html>

<head>
  <title>Login</title>
  <script src="/static/descope-web-component.js"></script>
</head>

<body>
  <div style="max-width: 500px; margin: auto;">
    <descope-wc project-id="{{ .ProjectID }}" flow-id="sign-up-or-in" theme="os"></descope-wc>
  </div>

  <script>
    const onSuccess = async (e) => {
      // Check if we're on the API domain or frontend domain
      // If Descope redirected us to staging.autokitteh.cloud but we need to be on staging-api.autokitteh.cloud
      const currentHost = window.location.host;
      const isOnFrontend = !currentHost.includes('-api.');

      let baseURL = window.location.origin;

      // If we're on the frontend but this is a CLI/VS Code login flow,
      // redirect to the API server instead
      if (isOnFrontend && currentHost.includes('autokitteh.cloud')) {
        // Convert staging.autokitteh.cloud -> staging-api.autokitteh.cloud
        baseURL = window.location.origin.replace('://', '://' + currentHost.split('.')[0] + '-api.');
      }

      // Build the callback URL with the JWT
      const url = new URL('/auth/descope/login', baseURL);
      url.searchParams.set('jwt', e.detail.sessionJwt);
      window.location.replace(url.toString());
    }

    const onError = (err) => console.error(err);

    const wcElement = document.getElementsByTagName("descope-wc")[0];
    wcElement.addEventListener("success", onSuccess);
    wcElement.addEventListener("error", onError);
  </script>
</body>

</html>
